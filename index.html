<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quota Nera</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    body { font-family: system-ui, Arial; max-width: 820px; margin: 24px auto; padding: 0 14px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 12px 0; }
    input { padding: 10px; border-radius: 10px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
    .row { display: grid; grid-template-columns: 1.4fr 0.8fr 0.5fr; gap: 10px; align-items: end; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #f6f6f6; cursor: pointer; }
    button:hover { background: #eee; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
    .muted { color: #666; font-size: 13px; }
    .topbar { display:flex; gap:10px; flex-wrap:wrap; }
    .pill { background:#fff7d6; border:1px solid #f0e1a1; padding:8px 10px; border-radius:999px; }
  </style>
</head>
<body>
  <h1>Quota Nera ðŸ˜…</h1>
  <div class="muted">Solo per scherzo tra amici. Nessun valore legale.</div>

  <div class="card">
    <div class="row">
      <div>
        <label>Nome</label>
        <input id="name" placeholder="Es. Gigi" />
      </div>
      <div>
        <label>Quota (â‚¬)</label>
        <input id="amount" type="number" min="0" step="1" placeholder="Es. 20" />
      </div>
      <div>
        <button id="addBtn">Aggiungi</button>
      </div>
    </div>
  </div>

  <div class="topbar">
    <div class="pill"><strong>Totale:</strong> <span id="total">0</span> â‚¬</div>
    <button id="copyBtn">Copia testo (WhatsApp)</button>
    <button id="csvBtn">Scarica CSV</button>
    <button id="clearBtn">Reset</button>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr><th>Nome</th><th>Quota (â‚¬)</th><th></th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
  // --- PWA: registra Service Worker (offline) ---
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
  }

  const KEY = "quotaNera_v1";
  let items = JSON.parse(localStorage.getItem(KEY) || "[]");

  const elName = document.getElementById("name");
  const elAmount = document.getElementById("amount");
  const elTbody = document.getElementById("tbody");
  const elTotal = document.getElementById("total");

  function save(){ localStorage.setItem(KEY, JSON.stringify(items)); }
  function euro(n){ return (Math.round(n * 100) / 100).toFixed(0); }

  function render(){
    elTbody.innerHTML = "";
    let tot = 0;

    items.forEach((it, idx) => {
      tot += it.amount;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(it.name)}</td>
        <td>${euro(it.amount)}</td>
        <td><button data-del="${idx}">Rimuovi</button></td>
      `;
      elTbody.appendChild(tr);
    });

    elTotal.textContent = euro(tot);

    elTbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-del"));
        items.splice(i,1);
        save(); render();
      });
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function addItem(){
    const name = elName.value.trim();
    const amount = Number(elAmount.value);

    if(!name) return alert("Metti un nome ðŸ˜‰");
    if(!Number.isFinite(amount) || amount < 0) return alert("Quota non valida");

    items.push({ name, amount: Math.round(amount) });
    save(); render();

    elName.value = "";
    elAmount.value = "";
    elName.focus();
  }

  document.getElementById("addBtn").addEventListener("click", addItem);
  elName.addEventListener("keydown", e => { if(e.key==="Enter") addItem(); });
  elAmount.addEventListener("keydown", e => { if(e.key==="Enter") addItem(); });

  document.getElementById("copyBtn").addEventListener("click", async () => {
    const lines = items.map(it => `- ${it.name}: ${euro(it.amount)}â‚¬`);
    const tot = items.reduce((a,b)=>a+b.amount,0);
    const txt = `Quota Nera (per scherzo)\n${lines.join("\n")}\nTotale: ${euro(tot)}â‚¬`;
    await navigator.clipboard.writeText(txt);
    alert("Testo copiato!");
  });

  document.getElementById("csvBtn").addEventListener("click", () => {
    const rows = [["Nome","Quota"], ...items.map(it => [it.name, it.amount])];
    const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "quota-nera.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    if(confirm("Resetto tutto?")) { items = []; save(); render(); }
  });

  render();
</script>
</body>
</html>
