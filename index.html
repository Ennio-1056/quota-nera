<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChiVaPerPrimo</title>
  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#666;
      --card:#fff; --border:#e6e6e6; --soft:#f5f5f5;
      --pillbg:#fff7d6; --pillbd:#f0e1a1;
      --dangerbg:#fff5f5; --dangerbd:#f0c3c3;
      --btn:#111; --btnText:#fff; --radius:16px;
    }
    body.dark{
      --bg:#0f1115; --text:#f2f2f2; --muted:#a8a8a8;
      --card:#151923; --border:#262c3a; --soft:#1b2130;
      --pillbg:#2a2414; --pillbd:#5c4a16;
      --dangerbg:#2a1717; --dangerbd:#5c2a2a;
      --btn:#f2f2f2; --btnText:#111;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:980px; margin:16px auto; padding:0 12px 28px; }
    h1{ margin:10px 0 4px; font-size:22px; }
    .muted{ color:var(--muted); font-size:13px; }
    .status{ color:var(--muted); font-size:13px; text-align:center; }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; margin:12px 0; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input{
      width:100%; padding:12px 12px; border-radius:14px; border:1px solid var(--border);
      background:transparent; color:var(--text); font-size:16px;
    }

    .btn{
      padding:12px 14px; border-radius:14px; border:1px solid var(--border);
      background:var(--soft); color:var(--text); cursor:pointer; font-size:15px;
      width:100%;
    }
    .btn-primary{ background:var(--btn); color:var(--btnText); border-color:var(--btn); }
    .btn-danger{ background:var(--dangerbg); border-color:var(--dangerbd); }

    .pill{
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      width:100%; padding:8px 12px; border-radius:999px;
      background:var(--pillbg); border:1px solid var(--pillbd); font-size:14px;
    }
    .mono{ font-variant-numeric: tabular-nums; }

    .form{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:720px){ .form{ grid-template-columns:1fr 1fr; } .span2{ grid-column:1/-1; } }

    .bar{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .bar .pill{ grid-column:1/-1; }
    .bar .status{ grid-column:1/-1; }

    .list{ display:grid; gap:10px; }
    .rowcard{
      border:1px solid var(--border); border-radius:14px; padding:12px; background:transparent;
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .who{ font-weight:900; }
    .sub{ margin-top:3px; color:var(--muted); font-size:13px; }
    .amt{ font-weight:900; font-size:18px; white-space:nowrap; }
    .small{ font-size:12px; color:var(--muted); }

    .winner{
      margin-top:10px; border:1px solid var(--pillbd); background:var(--pillbg);
      border-radius:14px; padding:10px 12px; font-weight:900;
    }

    .bars{ display:grid; gap:8px; margin-top:10px; }
    .barrow{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }
    .track{ height:10px; border-radius:999px; background:var(--soft); border:1px solid var(--border); overflow:hidden; }
    .fill{ height:100%; width:0%; background:var(--btn); }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ChiVaPerPrimo ðŸ˜…</h1>
    <div class="muted">Multiutente: tutti vedono le stesse giocate nella stessa room.</div>

    <div class="card">
      <div class="form">
        <div class="span2">
          <label>Room (codice gruppo)</label>
          <input id="room" placeholder="Es. ENNIO2026" />
          <div class="small">Condividi questo codice agli amici.</div>
        </div>

        <div>
          <label>Chi scommette</label>
          <input id="bettor" placeholder="Es. Ennio" />
        </div>
        <div>
          <label>Su chi</label>
          <input id="target" placeholder="Es. Mario" />
        </div>

        <div class="span2">
          <label>Quota (â‚¬)</label>
          <input id="amount" type="number" min="0" step="1" placeholder="20" />
        </div>

        <div class="span2 bar">
          <span class="pill">Totale: <b class="mono"><span id="total">0</span> â‚¬</b></span>

          <button class="btn btn-primary" id="addBtn">Aggiungi</button>
          <button class="btn" id="refreshBtn">Aggiorna</button>
          <button class="btn" id="copyBtn">Copia testo</button>
          <button class="btn" id="darkBtn">Dark</button>
          <button class="btn" id="autoBtn">Auto: OFF</button>
          <button class="btn btn-danger" id="clearBtn">Reset (admin)</button>

          <div class="status" id="status"></div>
        </div>

        <div class="span2">
          <button class="btn" id="pickBtn">ðŸŽ² Chi va per primo?</button>
          <div id="pickOut" class="winner" style="display:none"></div>
          <div class="small" style="margin-top:6px">Estrazione pesata sulle quote: piÃ¹ quota = piÃ¹ probabilitÃ .</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin:0 0 8px;">Giocate</div>
      <div class="list" id="plays"></div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin:0 0 8px;">Classifiche</div>

      <div style="margin-top:8px; font-weight:900;">Per Target</div>
      <div class="list" id="rankTargets"></div>

      <div style="margin-top:14px; font-weight:900;">Per Scommettitore</div>
      <div class="list" id="rankBettors"></div>

      <div style="margin-top:14px; font-weight:900;">ðŸ“Š Barre (Target)</div>
      <div class="bars" id="bars"></div>
    </div>
  </div>

<script>
  // âœ… INCOLLA QUI lâ€™URL della Web App Apps Script
  const API = "https://script.google.com/macros/s/AKfycbzdU9dUAHgK66s0jNBviEq05NHTkctapSkJh8Gonw6VxxvtS2o5K3ObbsTpXsyGqzjF/exec";

  const KEY_SETTINGS = "cvp_settings_v1";
  let autoTimer = null;
  let items = [];

  const $ = (id) => document.getElementById(id);
  const elRoom = $("room"), elBettor = $("bettor"), elTarget = $("target"), elAmount = $("amount");
  const elTotal = $("total"), elStatus = $("status");
  const elPlays = $("plays"), elRankTargets = $("rankTargets"), elRankBettors = $("rankBettors"), elBars = $("bars");
  const pickOut = $("pickOut");

  const norm = (s) => String(s||"").trim().replace(/\s+/g," ");
  const euro = (n) => Math.round(n).toFixed(0);
  const esc = (s) => String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  const setStatus = (m) => elStatus.textContent = m || "";

  function loadSettings(){
    const s = JSON.parse(localStorage.getItem(KEY_SETTINGS) || "{}");
    if (s.room) elRoom.value = s.room;
    if (s.bettor) elBettor.value = s.bettor;
    if (s.dark) document.body.classList.add("dark");
  }
  function saveSettings(){
    localStorage.setItem(KEY_SETTINGS, JSON.stringify({
      room: norm(elRoom.value),
      bettor: norm(elBettor.value),
      dark: document.body.classList.contains("dark")
    }));
  }

  function agg(arr, keyFn){
    const m = new Map();
    for (const it of arr){
      const k = keyFn(it);
      const o = m.get(k) || { total:0, count:0 };
      o.total += Number(it.amount)||0;
      o.count += 1;
      m.set(k, o);
    }
    return m;
  }
  function sortAgg(map){
    return [...map.entries()].sort((a,b)=> b[1].total - a[1].total || b[1].count - a[1].count || a[0].localeCompare(b[0]));
  }
  function badge(i){ return i===0?"ðŸ¥‡":i===1?"ðŸ¥ˆ":i===2?"ðŸ¥‰":"â€¢"; }

  async function apiList(room){
    const url = `${API}?action=list&room=${encodeURIComponent(room)}`;
    const r = await fetch(url, { cache: "no-store" });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "Errore list");
    return j.data;
  }

  async function apiAdd(room, bettor, target, amount){
    const r = await fetch(API, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"add", room, bettor, target, amount })
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "Errore add");
  }

  async function apiClear(room, admin){
    const r = await fetch(API, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"clear", room, admin })
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "Errore clear");
  }

  async function load(){
    try{
      saveSettings();
      const room = norm(elRoom.value);
      if (!room) { setStatus("Imposta la Room"); return; }
      setStatus("Caricoâ€¦");
      items = await apiList(room);
      render();
      setStatus("");
    } catch(e){
      setStatus("Errore: " + (e.message || e));
    }
  }

  async function add(){
    const room = norm(elRoom.value);
    const bettor = norm(elBettor.value);
    const target = norm(elTarget.value);
    const amount = Math.round(Number(elAmount.value)||0);

    if(!room) return alert("Metti la Room ðŸ˜‰");
    if(!bettor || !target) return alert("Inserisci scommettitore e target ðŸ˜‰");
    if(!Number.isFinite(amount) || amount < 0) return alert("Quota non valida");

    try{
      setStatus("Salvoâ€¦");
      await apiAdd(room, bettor, target, amount);
      elTarget.value = "";
      elAmount.value = "";
      elTarget.focus();
      await load();
    } catch(e){
      setStatus("Errore: " + (e.message || e));
    }
  }

  function pickWeightedTarget(){
    const byTarget = agg(items, x=>x.target);
    const list = [...byTarget.entries()].map(([name,v]) => ({ name, w: Math.max(0, v.total) }));
    const sum = list.reduce((a,b)=>a+b.w,0);
    if (!list.length || sum <= 0) return null;

    let r = Math.random() * sum;
    for (const it of list){ r -= it.w; if (r <= 0) return it.name; }
    return list[list.length-1].name;
  }

  async function clearAll(){
    const room = norm(elRoom.value);
    if (!room) return alert("Metti la Room ðŸ˜‰");
    const admin = prompt("Reset ADMIN: password");
    if (!admin) return;

    try{
      setStatus("Resetâ€¦");
      await apiClear(room, admin);
      pickOut.style.display = "none";
      await load();
    } catch(e){
      setStatus("Errore: " + (e.message || e));
      alert(e.message || e);
    }
  }

  function render(){
    const tot = items.reduce((a,b)=>a+(Number(b.amount)||0),0);
    elTotal.textContent = euro(tot);

    elPlays.innerHTML = items.map(it => `
      <div class="rowcard">
        <div>
          <div class="who">${esc(it.bettor)} <span class="small">su</span> ${esc(it.target)}</div>
          <div class="sub">Room: ${esc(norm(elRoom.value))}</div>
        </div>
        <div class="amt mono">${euro(it.amount)}â‚¬</div>
      </div>
    `).join("") || `<div class="muted">Nessuna giocata</div>`;

    const targets = sortAgg(agg(items, x=>x.target));
    const bettors = sortAgg(agg(items, x=>x.bettor));

    elRankTargets.innerHTML = targets.map(([name,v], i) => `
      <div class="rowcard">
        <div>
          <div class="who">${badge(i)} ${esc(name)}</div>
          <div class="sub mono">${v.count} giocate</div>
        </div>
        <div class="amt mono">${euro(v.total)}â‚¬</div>
      </div>
    `).join("") || `<div class="muted">â€”</div>`;

    elRankBettors.innerHTML = bettors.map(([name,v], i) => `
      <div class="rowcard">
        <div>
          <div class="who">${badge(i)} ${esc(name)}</div>
          <div class="sub mono">${v.count} giocate</div>
        </div>
        <div class="amt mono">${euro(v.total)}â‚¬</div>
      </div>
    `).join("") || `<div class="muted">â€”</div>`;

    const top = targets.slice(0,8);
    const max = top.length ? top[0][1].total : 0;
    elBars.innerHTML = top.map(([name,v]) => {
      const pct = max ? Math.round((v.total/max)*100) : 0;
      return `
        <div class="barrow">
          <div>
            <div style="font-weight:800">${esc(name)} <span class="small mono">(${euro(v.total)}â‚¬)</span></div>
            <div class="track"><div class="fill" style="width:${pct}%"></div></div>
          </div>
          <div class="mono small">${pct}%</div>
        </div>
      `;
    }).join("") || `<div class="muted">â€”</div>`;
  }

  $("addBtn").onclick = add;
  $("refreshBtn").onclick = load;
  $("clearBtn").onclick = clearAll;

  $("copyBtn").onclick = async () => {
    const room = norm(elRoom.value);
    const lines = items.map(it => `- ${it.bettor} su ${it.target}: ${euro(it.amount)}â‚¬`);
    const tot = items.reduce((a,b)=>a+(Number(b.amount)||0),0);
    const txt = `ChiVaPerPrimo (room ${room})\n${lines.join("\n")}\nTotale: ${euro(tot)}â‚¬`;
    await navigator.clipboard.writeText(txt);
    alert("Copiato!");
  };

  $("darkBtn").onclick = () => { document.body.classList.toggle("dark"); saveSettings(); };

  $("autoBtn").onclick = () => {
    const btn = $("autoBtn");
    if (autoTimer){ clearInterval(autoTimer); autoTimer=null; btn.textContent="Auto: OFF"; return; }
    autoTimer = setInterval(load, 10000);
    btn.textContent = "Auto: ON";
    load();
  };

  $("pickBtn").onclick = () => {
    const w = pickWeightedTarget();
    if (!w){ pickOut.style.display="none"; return alert("Non ci sono abbastanza dati ðŸ˜‰"); }
    pickOut.textContent = "ðŸŽ² Chi va per primo? â†’ " + w;
    pickOut.style.display = "block";
  };

  elRoom.addEventListener("change", load);
  elBettor.addEventListener("change", saveSettings);

  loadSettings();
  load();
</script>
</body>
</html>

