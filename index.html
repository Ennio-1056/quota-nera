<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quota Nera</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 980px; margin: 18px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; margin: 12px 0; }
    input { padding: 10px; border-radius: 12px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
    .row { display: grid; grid-template-columns: 1fr 1fr 0.6fr 0.45fr; gap: 8px; align-items: end; }
    button { padding: 10px 12px; border-radius: 12px; border: 1px solid #ccc; background: #f6f6f6; cursor: pointer; }
    button:hover { background: #eee; }
    table { width: 100%; border-collapse: collapse; font-size: 15px; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; vertical-align: top; }
    .topbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { background:#fff7d6; border:1px solid #f0e1a1; padding:6px 10px; border-radius:999px; display:inline-block; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 820px){ .grid2 { grid-template-columns: 1fr; } }
    .muted { color:#666; font-size:13px; }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <h2>Quota Nera üòÖ</h2>
  <div class="muted">Solo per scherzo tra amici.</div>

  <div class="card">
    <div class="row">
      <div>
        <label>Chi scommette</label>
        <input id="bettor" placeholder="Es. Ennio" />
      </div>
      <div>
        <label>Su chi</label>
        <input id="target" placeholder="Es. Mario" />
      </div>
      <div>
        <label>Quota (‚Ç¨)</label>
        <input id="amount" type="number" min="0" step="1" placeholder="20" />
      </div>
      <div>
        <button id="addBtn">Aggiungi</button>
      </div>
    </div>
  </div>

  <div class="topbar" style="margin:10px 0">
    <span class="pill">Totale: <b class="mono"><span id="total">0</span> ‚Ç¨</b></span>
    <button id="copyBtn">Copia testo</button>
    <button id="clearBtn">Reset</button>
  </div>

  <div class="grid2">
    <div class="card">
      <h3 style="margin:0 0 8px 0">Giocate</h3>
      <table>
        <thead>
          <tr>
            <th>Scommettitore</th>
            <th>Target</th>
            <th>Quota (‚Ç¨)</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Classifiche</h3>

      <div style="margin:8px 0 6px 0"><b>Per Target (chi √® pi√π ‚Äúscommesso‚Äù)</b></div>
      <table>
        <thead>
          <tr><th>Target</th><th class="mono">Totale ‚Ç¨</th><th class="mono"># giocate</th></tr>
        </thead>
        <tbody id="rankTargets"></tbody>
      </table>

      <div style="margin:14px 0 6px 0"><b>Per Scommettitore (chi punta di pi√π)</b></div>
      <table>
        <thead>
          <tr><th>Scommettitore</th><th class="mono">Totale ‚Ç¨</th><th class="mono"># giocate</th></tr>
        </thead>
        <tbody id="rankBettors"></tbody>
      </table>
    </div>
  </div>

<script>
  const KEY = "quotaNera_v3";
  let items = JSON.parse(localStorage.getItem(KEY) || "[]");

  const elBettor = document.getElementById("bettor");
  const elTarget = document.getElementById("target");
  const elAmount = document.getElementById("amount");
  const elTbody = document.getElementById("tbody");
  const elTotal = document.getElementById("total");
  const elRankTargets = document.getElementById("rankTargets");
  const elRankBettors = document.getElementById("rankBettors");

  const norm = (s) => s.trim().replace(/\s+/g, " ");
  const euro = (n) => Math.round(n).toFixed(0);

  function save(){ localStorage.setItem(KEY, JSON.stringify(items)); }

  function render(){
    // Tabella giocate
    elTbody.innerHTML = "";
    let tot = 0;

    items.forEach((it, idx) => {
      tot += it.amount;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(it.bettor)}</td>
        <td>${escapeHtml(it.target)}</td>
        <td class="mono">${euro(it.amount)}</td>
        <td><button data-del="${idx}">X</button></td>
      `;
      elTbody.appendChild(tr);
    });

    elTotal.textContent = euro(tot);

    elTbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.onclick = () => {
        items.splice(Number(btn.dataset.del), 1);
        save(); render();
      };
    });

    // Classifiche
    renderRankings();
  }

  function renderRankings(){
    const byTarget = new Map();
    const byBettor = new Map();

    for (const it of items){
      // Target
      const t = it.target;
      const tAgg = byTarget.get(t) || { total: 0, count: 0 };
      tAgg.total += it.amount; tAgg.count += 1;
      byTarget.set(t, tAgg);

      // Scommettitore
      const b = it.bettor;
      const bAgg = byBettor.get(b) || { total: 0, count: 0 };
      bAgg.total += it.amount; bAgg.count += 1;
      byBettor.set(b, bAgg);
    }

    const targets = [...byTarget.entries()]
      .sort((a,b) => b[1].total - a[1].total || b[1].count - a[1].count || a[0].localeCompare(b[0]));

    const bettors = [...byBettor.entries()]
      .sort((a,b) => b[1].total - a[1].total || b[1].count - a[1].count || a[0].localeCompare(b[0]));

    elRankTargets.innerHTML = targets.map(([name, v]) => `
      <tr>
        <td>${escapeHtml(name)}</td>
        <td class="mono">${euro(v.total)}</td>
        <td class="mono">${v.count}</td>
      </tr>
    `).join("") || `<tr><td colspan="3" class="muted">Nessuna giocata</td></tr>`;

    elRankBettors.innerHTML = bettors.map(([name, v]) => `
      <tr>
        <td>${escapeHtml(name)}</td>
        <td class="mono">${euro(v.total)}</td>
        <td class="mono">${v.count}</td>
      </tr>
    `).join("") || `<tr><td colspan="3" class="muted">Nessuna giocata</td></tr>`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function addItem(){
    const bettor = norm(elBettor.value);
    const target = norm(elTarget.value);
    const amount = Number(elAmount.value);

    if(!bettor || !target) return alert("Inserisci scommettitore e target üòâ");
    if(!Number.isFinite(amount) || amount < 0) return alert("Quota non valida");

    items.push({ bettor, target, amount: Math.round(amount) });
    save(); render();

    elTarget.value = "";
    elAmount.value = "";
    elTarget.focus();
  }

  document.getElementById("addBtn").onclick = addItem;
  elBettor.addEventListener("keydown", e => { if(e.key==="Enter") addItem(); });
  elTarget.addEventListener("keydown", e => { if(e.key==="Enter") addItem(); });
  elAmount.addEventListener("keydown", e => { if(e.key==="Enter") addItem(); });

  document.getElementById("copyBtn").onclick = async () => {
    const lines = items.map(it => `- ${it.bettor} su ${it.target}: ${euro(it.amount)}‚Ç¨`);
    const tot = items.reduce((a,b)=>a+b.amount,0);
    const txt = `Quota Nera (per scherzo)\n${lines.join("\n")}\nTotale: ${euro(tot)}‚Ç¨`;
    await navigator.clipboard.writeText(txt);
    alert("Copiato!");
  };

  document.getElementById("clearBtn").onclick = () => {
    if(confirm("Resetto tutto?")) { items = []; save(); render(); }
  };

  render();
</script>
</body>
</html>
